{"version":3,"file":"message-updaters.js","sources":["../../../../../src/activities/chat/stream/message-updaters.ts"],"sourcesContent":["/**\n * Message Updaters (Internal)\n *\n * Internal helper functions for updating UIMessage parts.\n * These are used by StreamProcessor to manage the message array.\n */\n\nimport type {\n  ThinkingPart,\n  ToolCallPart,\n  ToolResultPart,\n  UIMessage,\n} from '../../../types'\nimport type { ToolCallState, ToolResultState } from './types'\n\n/**\n * Update or add a text part to a message.\n *\n * If the last part is a text part, update it (continuing the same text segment).\n * Otherwise, create a new text part (starting a new text segment after tool calls).\n */\nexport function updateTextPart(\n  messages: Array<UIMessage>,\n  messageId: string,\n  content: string,\n): Array<UIMessage> {\n  return messages.map((msg) => {\n    if (msg.id !== messageId) {\n      return msg\n    }\n\n    const parts = [...msg.parts]\n    const lastPart = parts.length > 0 ? parts[parts.length - 1] : null\n\n    if (lastPart && lastPart.type === 'text') {\n      // Update the last text part (continuing same text segment)\n      parts[parts.length - 1] = { type: 'text', content }\n    } else {\n      // Create new text part (starting new text segment after tool calls/results)\n      parts.push({ type: 'text', content })\n    }\n\n    return { ...msg, parts }\n  })\n}\n\n/**\n * Update or add a tool call part to a message.\n */\nexport function updateToolCallPart(\n  messages: Array<UIMessage>,\n  messageId: string,\n  toolCall: {\n    id: string\n    name: string\n    arguments: string\n    state: ToolCallState\n  },\n): Array<UIMessage> {\n  return messages.map((msg) => {\n    if (msg.id !== messageId) {\n      return msg\n    }\n\n    const parts = [...msg.parts]\n    // Find by ID, not index!\n    const existingPartIndex = parts.findIndex(\n      (p): p is ToolCallPart => p.type === 'tool-call' && p.id === toolCall.id,\n    )\n\n    const toolCallPart: ToolCallPart = {\n      type: 'tool-call',\n      id: toolCall.id,\n      name: toolCall.name,\n      arguments: toolCall.arguments,\n      state: toolCall.state,\n    }\n\n    if (existingPartIndex >= 0) {\n      // Update existing tool call\n      parts[existingPartIndex] = toolCallPart\n    } else {\n      // Add new tool call at the end (preserve natural streaming order)\n      parts.push(toolCallPart)\n    }\n\n    return { ...msg, parts }\n  })\n}\n\n/**\n * Update or add a tool result part to a message.\n */\nexport function updateToolResultPart(\n  messages: Array<UIMessage>,\n  messageId: string,\n  toolCallId: string,\n  content: string,\n  state: ToolResultState,\n  error?: string,\n): Array<UIMessage> {\n  return messages.map((msg) => {\n    if (msg.id !== messageId) {\n      return msg\n    }\n\n    const parts = [...msg.parts]\n    const resultPartIndex = parts.findIndex(\n      (p): p is ToolResultPart =>\n        p.type === 'tool-result' && p.toolCallId === toolCallId,\n    )\n\n    const toolResultPart: ToolResultPart = {\n      type: 'tool-result',\n      toolCallId,\n      content,\n      state,\n      ...(error && { error }),\n    }\n\n    if (resultPartIndex >= 0) {\n      parts[resultPartIndex] = toolResultPart\n    } else {\n      parts.push(toolResultPart)\n    }\n\n    return { ...msg, parts }\n  })\n}\n\n/**\n * Update a tool call part with approval request metadata.\n */\nexport function updateToolCallApproval(\n  messages: Array<UIMessage>,\n  messageId: string,\n  toolCallId: string,\n  approvalId: string,\n): Array<UIMessage> {\n  return messages.map((msg) => {\n    if (msg.id !== messageId) {\n      return msg\n    }\n\n    const parts = [...msg.parts]\n    const toolCallPart = parts.find(\n      (p): p is ToolCallPart => p.type === 'tool-call' && p.id === toolCallId,\n    )\n\n    if (toolCallPart) {\n      toolCallPart.state = 'approval-requested'\n      toolCallPart.approval = {\n        id: approvalId,\n        needsApproval: true,\n      }\n    }\n\n    return { ...msg, parts }\n  })\n}\n\n/**\n * Update a tool call part's state (e.g., to \"input-complete\").\n */\nexport function updateToolCallState(\n  messages: Array<UIMessage>,\n  messageId: string,\n  toolCallId: string,\n  state: ToolCallState,\n): Array<UIMessage> {\n  return messages.map((msg) => {\n    if (msg.id !== messageId) {\n      return msg\n    }\n\n    const parts = [...msg.parts]\n    const toolCallPart = parts.find(\n      (p): p is ToolCallPart => p.type === 'tool-call' && p.id === toolCallId,\n    )\n\n    if (toolCallPart) {\n      toolCallPart.state = state\n    }\n\n    return { ...msg, parts }\n  })\n}\n\n/**\n * Update a tool call part with output.\n * Searches all messages to find the tool call by ID.\n */\nexport function updateToolCallWithOutput(\n  messages: Array<UIMessage>,\n  toolCallId: string,\n  output: any,\n  state?: ToolCallState,\n  errorText?: string,\n): Array<UIMessage> {\n  return messages.map((msg) => {\n    const parts = [...msg.parts]\n    const toolCallPart = parts.find(\n      (p): p is ToolCallPart => p.type === 'tool-call' && p.id === toolCallId,\n    )\n\n    if (toolCallPart) {\n      toolCallPart.output = errorText ? { error: errorText } : output\n      if (state) {\n        toolCallPart.state = state\n      } else {\n        toolCallPart.state = 'input-complete'\n      }\n    }\n\n    return { ...msg, parts }\n  })\n}\n\n/**\n * Update a tool call part with approval response.\n * Searches all messages to find the tool call by approval ID.\n */\nexport function updateToolCallApprovalResponse(\n  messages: Array<UIMessage>,\n  approvalId: string,\n  approved: boolean,\n): Array<UIMessage> {\n  return messages.map((msg) => {\n    const parts = [...msg.parts]\n    const toolCallPart = parts.find(\n      (p): p is ToolCallPart =>\n        p.type === 'tool-call' && p.approval?.id === approvalId,\n    )\n\n    if (toolCallPart && toolCallPart.approval) {\n      toolCallPart.approval.approved = approved\n      toolCallPart.state = 'approval-responded'\n    }\n\n    return { ...msg, parts }\n  })\n}\n\n/**\n * Update or add a thinking part to a message.\n */\nexport function updateThinkingPart(\n  messages: Array<UIMessage>,\n  messageId: string,\n  content: string,\n): Array<UIMessage> {\n  return messages.map((msg) => {\n    if (msg.id !== messageId) {\n      return msg\n    }\n\n    const parts = [...msg.parts]\n    const thinkingPartIndex = parts.findIndex((p) => p.type === 'thinking')\n\n    const thinkingPart: ThinkingPart = {\n      type: 'thinking',\n      content,\n    }\n\n    if (thinkingPartIndex >= 0) {\n      // Update existing thinking part\n      parts[thinkingPartIndex] = thinkingPart\n    } else {\n      // Add new thinking part at the end (preserve natural streaming order)\n      parts.push(thinkingPart)\n    }\n\n    return { ...msg, parts }\n  })\n}\n"],"names":[],"mappings":"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"}